<!-- app/views/emotion_logs/show_mobile.html.erb（モバイル詳細） -->
<div class="container mt-4 mobile-container emotion-log-show">
  <h1 class="text-center mt-3 mobile-title">
    <i class="bi bi-heart-pulse"></i> Emotion Log <i class="bi bi-heart-pulse"></i>
  </h1>

  <!-- レコードの情報を表示する部分 -->
  <div class="card mb-3 mobile-card">
    <div class="card-header d-flex justify-content-between align-items-center mobile-card-header py-1 px-2">
      <div class="d-flex align-items-center gap-1 mobile-header-user">
        <% if @emotion_log.user.avatar_url.present? %>
          <%= image_tag @emotion_log.user.avatar_url, alt: "投稿者のプロフィール画像", width: 40, height: 40, class: "rounded-circle mobile-avatar" %>
        <% else %>
          <%= image_tag "default_stick_figure.webp", alt: "デフォルトプロフィール画像", width: 36, height: 36, class: "rounded-circle mobile-avatar" %>
        <% end %>
        <span class="fw-bold mobile-username"><%= @emotion_log.user.name %></span>
      </div>
      <div class="mobile-meta">
        <strong>記録:</strong>
        <%= @emotion_log.created_at.strftime('%y-%m-%d %H:%M') %>

        <% if @emotion_log.tags.any? %>
          <span class="mobile-tags ms-2">
            <% @emotion_log.tags.each do |tag| %>
              <span class="badge bg-secondary me-1 mobile-tag"><%= tag.name %></span>
            <% end %>
          </span>
        <% end %>
      </div>
    </div>

    <div class="card-body text-center py-2 px-2 mobile-card-body">
      <p class="mb-1 mobile-emotion-text"><strong>感情:</strong> <%= @emotion_log.emotion %></p>
      <p class="mb-1 mobile-diary-text"><strong>日記:</strong> <%= @emotion_log.description %></p>

      <% if current_user == @emotion_log.user %>
        <%= button_to '編集',
              edit_emotion_log_path(@emotion_log, format: :turbo_stream),
              form: { data: { turbo_frame: "modal-container" } },
              class: 'btn btn-danger btn-sm mobile-edit-btn',
              method: :get %>
      <% end %>

      <%# ▼▼ デスクトップと同じTwitter共有ボタン（X）をモバイルにも追加 ▼▼ %>
      <% page_url   = request.original_url %>
      <% tweet_text = "今日の感情は #{@emotion_log.emotion}！！ この気分できいた曲は #{@emotion_log.track_name}！" %>
      <% hashtag    = " #EmotionMusicBox #エモム" %>
      <% share_text = "#{tweet_text}#{hashtag}" %>
      <% tweet_url  = "https://twitter.com/intent/tweet?text=#{CGI.escape(share_text)}&url=#{CGI.escape(page_url)}" %>

      <div class="mt-2">
        <%= link_to tweet_url,
              target: "_blank",
              rel: "noopener",
              class: "btn btn-dark btn-sm d-flex align-items-center gap-1 tweet-share-btn",
              id: "tweet-share-btn-mobile" do %>
          <i class="bi bi-twitter-x tweet-icon"></i>
          この曲をシェアする
        <% end %>
      </div>
      <%# ▲▲ ここまで共有ボタン ▲▲ %>

      <%# ===== 再生ジャケット + 再生オーバーレイ（index と同じ構成） ===== %>
      <% if @emotion_log.music_art_url.present? %>
        <div class="music-art-box mt-2 position-relative">
          <%= image_tag(@emotion_log.music_art_url,
                alt: "ジャケット画像",
                class: "music-art-img mobile-music-art-img",
                data: {
                  "play-url"             => @emotion_log.music_url,           # ★ 再生URL
                  "global-player-target" => "trackImage",                     # ★ Stimulus target
                  "track-id"             => @emotion_log.id                   # ★ 識別子
                }) %>

          <%# 再生アイコン（クリックで global-player#onPlayIconClick 発火） %>
          <i class="fa fa-play play-overlay-icon"
             data-action="click->global-player#onPlayIconClick"
             data-global-player-target="playIcon"
             data-track-id="<%= @emotion_log.id %>"></i>
        </div>
      <% else %>
        <%# ジャケットが無い場合のプレースホルダー（再生は不可） %>
        <div class="music-art-box mt-2 position-relative">
          <%= image_tag "placeholder.png",
                alt: "ジャケット画像（なし）",
                class: "music-art-img mobile-music-art-img" %>
        </div>
      <% end %>
      <%# ===== /再生ジャケット ===== %>
    </div>
  </div>

  <!-- ==== コメントページネーション（上・中央寄せ／クリックで comments フレームだけ更新） ==== -->
  <!-- ※ 別フレームは使わず、comments本体と一緒に差し替わるようにする -->
  <div class="d-flex justify-content-center">
    <div class="card mb-3 w-100 mobile-comment-card">
      <div class="card-header py-1 px-2 mobile-comment-header">
        <strong id="comment-count">コメント (<%= @emotion_log.comments_count %>)</strong>
      </div>
      <div class="card-body py-2 px-2 mobile-comment-body">
        <turbo-frame id="new_comment">
          <%= form_with url: emotion_log_comments_path(@emotion_log),
                        data: {
                          controller:    "comment-form",
                          action:        "turbo:submit-start->comment-form#sending turbo:submit-end->comment-form#sent",
                          turbo_stream:  true
                        },
                        class: "mb-2" do |f| %>
            <%= f.text_area :body,
                  rows: 2,
                  class: "form-control mobile-comment-textarea",
                  placeholder: "コメントを入力…",
                  data: { comment_form_target: "textarea" } %>
            <%= f.submit "送信",
                  class: "btn btn-primary btn-xs mt-1 mobile-comment-submit",
                  data: { comment_form_target: "submit" } %>
          <% end %>
        </turbo-frame>

        <turbo-frame id="comments">
          <!-- 上：戻る（root）＋ページネーション（中央） -->
          <div class="d-flex align-items-center justify-content-between my-2">
            <div class="flex-shrink-0">
              <%= link_to "← 一覧に戻る",
                          root_path,
                          class: "btn neon_show neon_show-back btn-sm",
                          data: { turbo: false } %>
            </div>
            <nav class="flex-grow-1 d-flex justify-content-center">
              <div class="d-flex flex-wrap justify-content-center">
                <%= paginate @comments, params: request.query_parameters.merge(view: "mobile") %>
              </div>
            </nav>
            <div class="flex-shrink-0">
              <span class="btn neon_show neon_show-back btn-sm invisible">← 一覧に戻る</span>
            </div>
          </div>

          <!-- 本文＋下のページネーション -->
          <div id="comments-list" data-comment_form_target="comments">
            <%= render @comments %>
            <div class="mt-2 d-flex justify-content-center flex-wrap">
              <%= paginate @comments, params: request.query_parameters.merge(view: "mobile") %>
            </div>
          </div>
        </turbo-frame>
      </div>
    </div>
  </div>
</div>
