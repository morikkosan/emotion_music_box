<!-- app/views/emotion_logs/index.html.erb -->
<% content_for :title, "„Ç®„É¢„Éü„É•" %>

<%= render 'shared/header' %>

<% if user_signed_in? %>
  <% if @bookmark_page.present? %>
    <span class="bookmark_title"><%= @bookmark_page %></span>
  <% elsif @mypage_title.present? %>
    <span class="bookmark_title"><%= @mypage_title %></span>
  <% elsif @recommended_page.present? %>
    <span class="bookmark_title"><%= @recommended_page %></span>
  <% else %>
    <!-- ÈÄöÂ∏∏„ÅÆ„Çπ„Éà„É¨„Çπ„Ç≤„Éº„Ç∏ -->
    <br>
    <div id="hp-bar-container">
      <span class="today_mental_text">
        üëÜToday's stress level <span id="bar-width-display"></span>üëÜ
      </span>
      <p id="hp-status-text">„É°„É≥„Çø„É´Ê≠£Â∏∏</p>
      <div id="hp-bar"></div>
    </div>
    <br>
  <% end %>
<% end %>

<% if @bookmark_page.present? %>
  <div data-controller="bookmark" style="margin: 1.5rem 0 2rem 1rem;">
    <div style="display: flex; justify-content: center; align-items: center; gap: 8rem;">
      <!-- ‚úÖ „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ -->
      <label class="bookmark-merge-toggle-label" style="margin: 0;">
        <input type="checkbox"
               id="mypage-merge-toggle"
               class="form-check-input"
               data-action="change->bookmark#toggleMyPageLogs"
               name="include_my_logs">
        „Éû„Ç§„Éö„Éº„Ç∏„ÅÆÊäïÁ®ø„ÇÇÂê´„ÇÅ„Çã
      </label>

      <!-- ‚úÖ „Éó„É¨„Ç§„É™„Çπ„Éà‰ΩúÊàê„Éú„Çø„É≥ -->
      <% if current_user.playlists.count < 12 %>
        <form action="<%= new_playlist_path(format: :turbo_stream) %>"
              method="get"
              data-turbo-frame="playlist-modal-container"
              data-action="submit->bookmark#submitPlaylistForm"
              style="margin: 0;">
          <button type="submit" class="bookmark-playlist-create-btn">
            „Éó„É¨„Ç§„É™„Çπ„Éà„Çí‰ΩúÊàê„Åô„Çã
          </button>
        </form>
      <% else %>
        <button class="btn btn-secondary" disabled>„Éó„É¨„Ç§„É™„Çπ„Éà„ÅØ12ÂÄã„Åæ„Åß‰ΩúÊàêÂèØËÉΩ„Åß„Åô</button>
      <% end %>
    </div>
  </div>
<% end %>



<% if user_signed_in? %>
  <br><br><br><br>
  <div class="main-content">
    <% if @bookmark_page.present? || @mypage_title.present? %>
      <div id="playlist-sidebar">
        <%= render 'emotion_logs/playlist_sidebar',
                   playlists: current_user.playlists.includes(:playlist_items, :emotion_logs) %>
      </div>
    <% else %>
      <%= render 'super_search' %>
    <% end %>
si<% end %>


<%= turbo_frame_tag "logs_list" do %>
  <div class="scroll-content">

  <div class="row justify-content-center">
    <% @emotion_logs.each do |log| %>
        <% cache log do %>
      <div id="<%= dom_id(log) %>" class="col-md-8 mb-4">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <% if @bookmark_page.present? %>
              <input type="checkbox"
                    name="selected_logs[]"
                    value="<%= log.id %>"
                    class="playlist-check me-3"
                    style="width:2.2rem; height:2.2rem; accent-color:#e800ff;
                            box-shadow:0 0 8px #fff6, 0 0 3px #e800ff;">
            <% end %>

            <div>
              <strong><%= log.created_at.in_time_zone('Tokyo')
                         .strftime('%Y/%m/%d %H:%M') %></strong>
              <% log.tags.each do |tag| %>
                <% if user_signed_in? %>
                  <%= link_to tag.name,
                              emotion_logs_path(genre: tag.name),
                              class: "badge bg-primary text-light me-1" %>
                <% else %>
                  <span class="badge bg-primary text-light me-1"
                        title="„É≠„Ç∞„Ç§„É≥„Åô„Çã„Å®‰Ωø„Åà„Åæ„Åô"><%= tag.name %></span>
                <% end %>
              <% end %>
            <% end %>
            </div>

            <div class="d-flex align-items-center gap-3">
              <% if current_user == log.user %>
                <%= form_with url: emotion_log_path(log),
                              method: :delete,
                              data: { turbo_confirm: 'Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü',
                                      turbo_stream: true },
                              class: 'd-inline' do %>
                  <%= submit_tag 'ÂâäÈô§', class: 'btn btn-danger btn-sm' %>
                <% end %>
              <% else %>
                <%= render 'bookmark_buttons', emotion_log: log %>
              <% end %>

              <div class="d-flex align-items-center" style="gap:4px;">
                <span class="fw-bold" style="font-size:1rem;"><%= log.comments_count %></span>
                <%= image_tag 'comment_icon.webp',
                              alt: '„Ç≥„É°„É≥„ÉàÊï∞',
                              style: 'width:48px; height:48px; display:inline-block;' %>
              </div>
            </div>
          </div>

          <div class="card-body">
            <div class="d-flex align-items-start">

              <div class="me-3 position-relative" style="width:80px;">
                <!-- ‚ñº „Åì„Åì„Åå‰øÆÊ≠£„Éù„Ç§„É≥„ÉàÔºÅ -->
                <%= image_tag log.music_art_url || "placeholder.webp",
                              alt: "„Ç∏„É£„Ç±„ÉÉ„ÉàÁîªÂÉè",
                              class: "music-art-img",
                              style: "width:80px; height:auto; display:block;",
                              data: {
                                "play-url"             => log.music_url,
                                "global-player-target" => "trackImage",
                                "track-id"             => log.id
                              } %>

                <i class="fa fa-play play-overlay-icon"
                   data-action="click->global-player#loadAndPlay"
                   data-global-player-target="playIcon"
                   data-track-id="<%= log.id %>"
                   style="
                     position: absolute;
                     top: 50%;
                     left: 50%;
                     transform: translate(-50%, -50%);
                     font-size: 24px;
                     color: rgba(255,255,255,0.9);
                     cursor: pointer;
                   "></i>
              </div>

              <div class="d-flex align-items-center">
                <div>
                  <%= link_to log.emotion,
                              emotion_log_path(log),
                              class: "button",
                              data: { turbo: false } %>
                </div>
                <div class="ms-3">
                  <p class="mb-0" style="color:white; font-size:1.1rem;">
                    <%= log.description.present? ? log.description : "‰∏ÄË®Ä„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì" %>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
    </div>
  </div>
<% end %>

<%= paginate @emotion_logs %>

<%= link_to "‰ªäÊó•„ÅÆÊ∞óÊåÅ„Å°„ÇíË®òÈå≤„Åô„Çã",
            new_emotion_log_path(format: :turbo_stream),
            id: "record-button",
            data: { controller: "record-btn",
                    action: "click->record-btn#hide",
                    turbo_prefetch: false },
            class: "btn btn-primary floating-btn" %>
