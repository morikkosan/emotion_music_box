<div data-controller="view-switcher">

  <div id="desktop-view">

    <!-- ‚ñº ËøΩÂä†Ôºö„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÁâà„ÅÆ„Äå‰∏ÄÁï™‰∏ä„Äç„Å´„Éï„ÉÉ„Çø„Éº -->
    <%= render "shared/footer" %>

    <!-- app/views/emotion_logs/index.html.erb -->
    <% content_for :title, "„Ç®„É¢„Éü„É•" %>
    <%= render 'shared/header' %>

    <% if user_signed_in? %>
      <% if @bookmark_page.present? %>
        <span class="bookmark_title"><%= @bookmark_page %></span>
      <% elsif @mypage_title.present? %>
        <span class="bookmark_title"><%= @mypage_title %></span>
      <% elsif @recommended_page.present? %>
        <span class="bookmark_title"><%= @recommended_page %></span>
      <% else %>
        <!-- ÈÄöÂ∏∏„ÅÆ„Çπ„Éà„É¨„Çπ„Ç≤„Éº„Ç∏ -->
        <br>
        <div id="hp-bar-container">
          <span class="today_mental_text">
            üëÜToday's stress level <span id="bar-width-display"></span>üëÜ
          </span>
          <p id="hp-status-text">„É°„É≥„Çø„É´Ê≠£Â∏∏</p>
          <div id="hp-bar"></div>
        </div>
      <% end %>
    <% end %>

    <% if @bookmark_page.present? %>
      <div data-controller="bookmark" class="bookmark-panel">
        <div class="bookmark-toolbar">
          <!-- ‚úÖ „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ -->
          <label class="bookmark-merge-toggle-label">
          <input type="checkbox"
         id="mypage-merge-toggle"
         class="form-check-input"
         data-action="change->bookmark#toggleMyPageLogs"
         name="include_my_logs"
         value="true">
  „Éû„Ç§„Éö„Éº„Ç∏„ÅÆÊäïÁ®ø„ÇÇÂê´„ÇÅ„Çã
</label>

          <!-- ‚úÖ „Éó„É¨„Ç§„É™„Çπ„Éà‰ΩúÊàê„Éú„Çø„É≥ -->
          <% if current_user.playlists.count < 12 %>
          <!-- ‚òÖ„Åì„Åì„Çí‰øÆÊ≠£Ôºöplaylist-modal „Å´ -->
          <div data-controller="playlist-modal" data-playlist-modal-id-value="playlist-modal">
            <button type="button" class="bookmark-playlist-create-btn" data-action="click->playlist-modal#open">
              „Éó„É¨„Ç§„É™„Çπ„Éà„Çí‰ΩúÊàê„Åô„Çã
            </button>
          </div>
        <% else %>
          <button class="btn btn-secondary" disabled>„Éó„É¨„Ç§„É™„Çπ„Éà„ÅØ12ÂÄã„Åæ„Åß‰ΩúÊàêÂèØËÉΩ„Åß„Åô</button>
        <% end %>
        </div>
      </div>
    <% end %>

    <% if user_signed_in? %>
      <br><br><br>
      <div class="main-content">
        <% if @bookmark_page.present? || @mypage_title.present? %>
          <div id="playlist-sidebar">
            <%= render 'emotion_logs/playlist_sidebar',
              playlists: current_user.playlists.includes(:playlist_items, :emotion_logs) %>
          </div>
        <% else %>
          <%= render 'super_search' %>
        <% end %>
      </div>
    <% end %>  <!-- ‚Üê„Åì„ÅÆ‰ΩçÁΩÆ„ÅßOKÔºÅ -->

    <!-- turbo_frame_tag„ÅÆ‰∏≠„Å´„ÅØ„Éú„Çø„É≥„ÇíÂÖ•„Çå„Å™„ÅÑ -->
    <%= turbo_frame_tag "logs_list" do %>
      <div class="scroll-content">
        <div class="row justify-content-center">
          <% @emotion_logs.each do |log| %>
            <div id="<%= dom_id(log) %>" class="col-md-8 mb-4">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <% if @bookmark_page.present? %>
                    <input type="checkbox"
                      name="selected_logs[]"
                      value="<%= log.id %>"
                      class="playlist-check me-3 playlist-check-accent">
                  <% end %>

                  <div>
                    <strong><%= log.created_at.in_time_zone('Tokyo').strftime('%Y/%m/%d %H:%M') %></strong>
                    <% log.tags.each do |tag| %>
                      <% if user_signed_in? %>
                        <%= link_to tag.name,
                          emotion_logs_path(genre: tag.name),
                          class: "badge bg-primary text-light me-1" %>
                      <% else %>
                        <span class="badge bg-primary text-light me-1"
                          title="„É≠„Ç∞„Ç§„É≥„Åô„Çã„Å®‰Ωø„Åà„Åæ„Åô"><%= tag.name %></span>
                      <% end %>
                    <% end %>
                  </div>
                  <div class="d-flex align-items-center gap-3">
                    <% if current_user == log.user %>
                      <%= form_with url: emotion_log_path(log),
                          method: :delete,
                          data: { turbo_confirm: 'Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü',
                                  turbo_stream: true },
                          class: 'd-inline' do %>
                        <%= submit_tag 'ÂâäÈô§', class: 'btn btn-danger btn-sm' %>
                      <% end %>
                    <% else %>
                      <%= render 'bookmark_buttons', emotion_log: log %>
                    <% end %>
                    <div class="d-flex align-items-center comment-count-box">
                      <span class="fw-bold comment-count-number">
                        <%= log.comments_count %></span>
                      <%= image_tag 'comment_icon.webp',
                        alt: '„Ç≥„É°„É≥„ÉàÊï∞',
                        class: "comment-icon" %>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="d-flex align-items-start">
                    <div class="me-3 position-relative music-art-box">
                      <%= image_tag log.music_art_url || "placeholder.png",
                        alt: "„Ç∏„É£„Ç±„ÉÉ„ÉàÁîªÂÉè",
                        class: "music-art-img",
                        data: {
                          "play-url"             => log.music_url,
                          "global-player-target" => "trackImage",
                          "track-id"             => log.id
                        } %>
                      <i class="fa fa-play play-overlay-icon"
                        data-action="click->global-player#onPlayIconClick"
                        data-global-player-target="playIcon"
                        data-track-id="<%= log.id %>"></i>
                    </div>
                    <div class="d-flex align-items-center">
                      <div>
                        <%= link_to log.emotion,
                          emotion_log_path(log),
                          class: "button",
                          data: { turbo: false } %>
                      </div>
                      <div class="ms-3">
                        <p class="mb-0 log-description">
                          <%= log.description.present? ? log.description : "‰∏ÄË®Ä„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì" %>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- „Åì„Åì„Åã„Çâ‰∏ã turbo_frame_tag„ÅÆÂ§ñÔºÅÁµ∂ÂØæÂ§ñÔºÅ -->
    <% if user_signed_in? %>
      <%= paginate @emotion_logs %>
      <%= link_to "‰ªäÊó•„ÅÆÊ∞óÊåÅ„Å°„ÇíË®òÈå≤„Åô„Çã",
        new_emotion_log_path(format: :turbo_stream),
        id: "record-button",
        data: { controller: "record-btn", action: "click->record-btn#hide", turbo_prefetch: false },
        class: "btn btn-primary floating-btn" %>
    <% end %>

  </div> <!-- #desktop-view -->

  <!-- ================= „É¢„Éê„Ç§„É´„Éì„É•„Éº ================= -->
  <div id="mobile-view">

    <!-- ‚ñº ËøΩÂä†Ôºö„É¢„Éê„Ç§„É´Áâà„ÅÆ„Äå‰∏ÄÁï™‰∏ä„Äç„Å´„Éï„ÉÉ„Çø„Éº -->
    <%= render "shared/footer" %>

    <% content_for :title, "„Ç®„É¢„Éü„É•" %>
    <div class="container mt-3 position-relative">


        <% if user_signed_in? %>
  <div class="user-dropdown-wrapper">
    <div class="user-dropdown" data-controller="user-dropdown">
      <div class="user-bar" data-action="click->user-dropdown#toggle">
        <%= image_tag current_user.profile_avatar_url, size: "32x32", class: "rounded-circle", alt: current_user.name %>
        <span class="ms-2 text-white"><%= current_user.name %></span>
      </div>

      <div class="dropdown-menu" data-user-dropdown-target="menu">
        <!-- ‚úÖ ID„ÅØ‰ªò„Åë„Å™„ÅÑ / Rails„ÅÆ„É≠„Ç∞„Ç¢„Ç¶„Éà„Éë„Çπ„Åß -->
        <%= button_to destroy_user_session_path,
              method: :delete,
              form:  { data: { turbo: false, logout_form: true }, class: "m-0 p-0 d-inline" },
              class: "dropdown-item d-flex align-items-center text-danger" do %>
  <%= image_tag "log_out.webp", class: "dropdown-icon me-2", alt: "" %>
  „É≠„Ç∞„Ç¢„Ç¶„Éà
<% end %>



        <div class="dropdown-divider"></div>

        <%= link_to edit_user_registration_path(view: (mobile_device? ? 'mobile' : nil)),
                    class: "dropdown-item d-flex align-items-center" do %>
          <%= image_tag "profile_edit.webp", class: "dropdown-icon me-2", alt: "" %>
          „Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ
        <% end %>

    <%= render "shared/notification_toggle", frame_id: "notification-toggle-mobile" %>

        <%= link_to new_contact_path, class: "dropdown-item d-flex align-items-center" do %>
          <%= image_tag "form_contact.webp", class: "dropdown-icon me-2", alt: "" %>
          „ÅäÂïè„ÅÑÂêà„Çè„Åõ
        <% end %>
      </div>
    </div>
  </div>
<% end %>


      <div class="text-start mt-2 px-3">
        <%= link_to emotion_logs_path do %>
          <%= image_tag "logo1.webp", alt: "Emotion List Logo", class: "img-fluid neon-icon mobile-logo" %>
        <% end %>
      </div>
      <br><br>
      <% unless user_signed_in? %>
        <div class="text-center mt-5 mb-4">
          <h1 class="mobile-catchcopy">Èü≥Ê•Ω„Å®„Çπ„Éà„É¨„Çπ„ÇíÊîØÈÖç„Åô„Çã</h1>
        </div>
        <div class="neon-btn-panel text-center mt-4">
          <%= link_to "https://soundcloud.com/signup", target: "_blank", rel: "noopener", class: "neon-btn btn-neon-xl me-3" do %>
            <div class="neon-main-btn-title">Êñ∞Ë¶è‰ΩúÊàê</div>
            <div class="neon-btn-sub">(SoundCloud„Ç¢„Ç´„Ç¶„É≥„Éà„ÇÇÁ∞°Âçò‰ΩúÊàê)</div>
          <% end %>
          <%= button_to user_soundcloud_omniauth_authorize_path, method: :post, class: "neon-btn btn-neon-xl", data: { turbo: false } do %>
            <div class="neon-main-btn-title">„É≠„Ç∞„Ç§„É≥„Åó„Å¶Âßã„ÇÅ„Çã</div>
          <% end %>
        </div>
        <div class="neon-btn-footer large-text text-center mt-2">
          <strong>‚Äª „ÅØ„Åò„ÇÅ„Å¶„ÅÆÊñπ„ÅØÊñ∞Ë¶è‰ΩúÊàê„ÅßÁôªÈå≤Âæå„ÄÅ<br>
            „Åì„ÅÆÁîªÈù¢„Å´Êàª„Å£„Å¶„Äå„É≠„Ç∞„Ç§„É≥„Åó„Å¶Âßã„ÇÅ„Çã„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„ÄÅ„Åï„Çâ„Å´„ÄåConnect and Continue„Äç„ÇíÊäº„Åõ„Å∞„ÄÅ„ÅÇ„Å™„Åü„ÅÆÊñ∞„Åó„ÅÑÈü≥Ê•Ω„ÅÆÊóÖ„ÅåÂßã„Åæ„Çä„Åæ„Åô„ÄÇ</strong>
        </div>
      <% end %>
    </div>


    
    <!-- turbo_frame_tag„ÅÆ‰∏≠„Å´„ÅØ„Éú„Çø„É≥„ÇíÂÖ•„Çå„Å™„ÅÑ -->
    <%= turbo_frame_tag "logs_list_mobile" do %>
      <%# index.html.erb ÂÜÖ„ÄÅ@bookmark_page.present? „ÅÆ„É¢„Éê„Ç§„É´ÂàÜÂ≤ê„Éñ„É≠„ÉÉ„ÇØ„Çí„Åì„ÅÆ„Åæ„ÅæÁΩÆ„ÅçÊèõ„Åà %>
<% if @bookmark_page.present? %>
  <div class="bookmark_title"><%= @bookmark_page %></div>
  <div data-controller="bookmark" class="bookmark-panel">
    <div class="bookmark-toolbar">

      <!-- ‚ñº „É¢„Éê„Ç§„É´„ÅäÊ∞ó„Å´ÂÖ•„ÇäÂ∞ÇÁî®„ÅÆGET„Éï„Ç©„Éº„É†Ôºàturbo-frame„ÅßÈÉ®ÂàÜÊõ¥Êñ∞Ôºâ -->
      <form id="mobile-bookmarks-form"
            action="<%= bookmarks_emotion_logs_path(view: 'mobile') %>"
            method="get"
            data-turbo-frame="logs_list_mobile">
        <input type="hidden" name="view" value="mobile">
        <%= hidden_field_tag :genre,   params[:genre]   if params[:genre].present?  %>
        <%= hidden_field_tag :emotion, params[:emotion] if params[:emotion].present?%>
        <%= hidden_field_tag :sort,    params[:sort]    if params[:sort].present?   %>
        <%= hidden_field_tag :period,  params[:period]  if params[:period].present? %>
      </form>

      <label class="bookmark-merge-toggle-label">
        <input type="checkbox"
          id="mypage-merge-toggle-mobile"
          class="form-check-input"
          name="include_my_logs"
          value="true"
          form="mobile-bookmarks-form"
          data-action="change->bookmark#toggleMyPageLogs"
          <%= 'checked' if ActiveModel::Type::Boolean.new.cast(params[:include_my_logs]) %>>
        „Éû„Ç§„Éö„Éº„Ç∏„ÅÆÊäïÁ®ø„ÇÇÂê´„ÇÅ„Çã
      </label>

      <% if current_user.playlists.count < 12 %>
        <div data-controller="playlist-modal" data-playlist-modal-id-value="playlist-modal-mobile">
          <button type="button" class="bookmark-playlist-create-btn" data-action="click->playlist-modal#open">
            „Éó„É¨„Ç§„É™„Çπ„Éà„Çí‰ΩúÊàê„Åô„Çã
          </button>
        </div>
      <% else %>
        <button class="btn btn-secondary" disabled>„Éó„É¨„Ç§„É™„Çπ„Éà„ÅØ12ÂÄã„Åæ„Åß‰ΩúÊàêÂèØËÉΩ„Åß„Åô</button>
      <% end %>

    </div>
  </div>
<% elsif @mypage_title.present? %>
  <span class="bookmark_title"><%= @mypage_title %></span>
<% elsif @recommended_page.present? %>
  <span class="bookmark_title"><%= @recommended_page %></span>
<% else %>
  <div class="mobile-hp-bar-container">
    <div class="mobile-hp-bar" id="hp-bar"></div>
    <span class="mobile_today_mental_text">
      üëÜToday's stress level <span id="bar-width-display-mobile"></span>üëÜ
    </span>
  </div>
<% end %>

            <div class="mobile-pagination-center">
            <%= paginate @emotion_logs,
              params: request.query_parameters.merge(view: "mobile") %>
            </div>
      <div class="mobile-content pb-5 px-3 mt-4">
        <%= render partial: "emotion_logs/mobile_list", locals: { logs: @emotion_logs } %>
        <div class="player-space-spacer"></div>
      </div>
    <% end %>
    <!-- turbo_frame_tag„ÅÆÂ§ñ„Å´Âá∫„Åó„Åü„Éú„Çø„É≥ -->
    <% if user_signed_in? %>
      <div class="w-100 text-center my-4 record-mobile-btn-wrap">
        <%= link_to "‰ªäÊó•„ÅÆÊ∞óÊåÅ„Å°„ÇíË®òÈå≤„Åô„Çã",
          new_emotion_log_path(format: :turbo_stream),
        id: "record-button-mobile",
          class: "record-mobile-button",
          data: { controller: "record-btn", action: "click->record-btn#hide", turbo_prefetch: false } %>
      </div>
    <% end %>

    <% if user_signed_in? %>
       <nav
    class="mobile-footer fixed-bottom bg-dark text-white d-flex justify-content-evenly py-2"
    data-controller="mobile-footer"
  >
    <%= link_to emotion_logs_path,
      class: "text-center text-white small",
      data: {
        "mobile-footer-target": "item",
        section: "home",
        action: "click->mobile-footer#onClick",
        turbo_frame: "logs_list_mobile",
        turbo_action: "advance"
      } do %>
      <i class="bi bi-house fs-4"></i><br>„Éõ„Éº„É†
    <% end %>

    <%= link_to recommended_emotion_logs_path,
      class: "text-center text-white small",
      data: {
        "mobile-footer-target": "item",
        section: "recommended",
        action: "click->mobile-footer#onClick",
        turbo_frame: "logs_list_mobile",
        turbo_action: "advance"
      } do %>
      <i class="bi bi-fire fs-4"></i><br>„Åä„Åô„Åô„ÇÅüî•
    <% end %>

    <button type="button"
  class="text-center text-white small btn btn-link p-0"
  data-controller="mobile-super-search"
  data-mobile-super-search-modal-id-value="mobile-super-search-modal"
  data-action="click->mobile-super-search#open">
  <i class="bi bi-search fs-4"></i><br>Ê§úÁ¥¢
</button>


    <%= link_to my_emotion_logs_path,
      class: "text-center text-white small",
      data: {
        "mobile-footer-target": "item",
        section: "mypage",
        action: "click->mobile-footer#onClick",
        turbo_frame: "logs_list_mobile",
        turbo_action: "advance"
      } do %>
      <i class="bi bi-person fs-4"></i><br>„Éû„Ç§„Éö„Éº„Ç∏
    <% end %>

    <%= link_to bookmarks_emotion_logs_path(view: "mobile"),
      class: "text-center text-white small",
      data: {
        "mobile-footer-target": "item",
        section: "bookmarks",
        action: "click->mobile-footer#onClick",
        turbo_frame: "logs_list_mobile",
        turbo_action: "advance"
      } do %>
      <i class="bi bi-heart fs-4"></i><br>„ÅäÊ∞ó„Å´ÂÖ•„Çä
    <% end %>

    <%= link_to "#",
      id: "show-playlist-modal-mobile",
      class: "text-center text-white small",
      data: {
        "mobile-footer-target": "item",
        section: "playlist",
        action: "click->mobile-footer#onPlaylistClick",
        controller: "playlist-modal",
        "playlist-modal-modal-id-value": "playlist-modal-mobile",
        turbo: false
      } do %>
      <i class="bi bi-music-note-list fs-4"></i><br>„Éó„É¨„Ç§„É™„Çπ„Éà
    <% end %>
  </nav>


      <!-- index.html.erb „ÅÆ„É¢„Éê„Ç§„É´Áî®„É¢„Éº„ÉÄ„É´ -->
<div id="playlist-modal-mobile" class="modal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" id="playlist-modal-content-mobile">
      <%= render 'emotion_logs/playlist_sidebar',
            playlists: current_user.playlists.includes(:playlist_items, :emotion_logs) %>
    </div>
  </div>
</div>

    <% end %>
  </div>
</div>
