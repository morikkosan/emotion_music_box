<div class="p-3">
  <% if @notifications.blank? %>
    <div class="alert alert-light border m-3">通知はありません。</div>
  <% else %>
    <div class="list-group list-group-flush">
      <% @notifications.each do |n| %>
        <div class="list-group-item d-flex align-items-start gap-3" id="notification-<%= n.id %>">
          <span class="notif-dot-placeholder mt-1" aria-hidden="true"></span>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-center">
              <strong class="me-2"><%= n.title %></strong>
              <small class="text-muted">
                <%= l(n.created_at, format: :short) rescue n.created_at.strftime("%Y/%m/%d %H:%M") %>
              </small>
            </div>

            <% if n.body.present? %>
              <p class="mb-1 text-break"><%= n.body %></p>
            <% end %>

            <% if n.url.present? %>
              <%= link_to "開く", n.url,
                    class: "small text-decoration-underline",
                    data: { turbo: false } %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <div class="border-top mt-2"></div>

    <%# ===== 自前ページネーション: 1ページ10件 / 合計@total_count(<=30) ===== %>
    <% per_page = 10
       total_pages = (@total_count.to_i <= 0) ? 1 : ((@total_count.to_f / per_page).ceil)
       current_page = params[:page].to_i
       current_page = 1 if current_page < 1
       current_page = total_pages if current_page > total_pages
       prev_page = (current_page > 1) ? (current_page - 1) : nil
       next_page = (current_page < total_pages) ? (current_page + 1) : nil
       range_start = (current_page - 1) * per_page + 1
       range_end   = (range_start + @notifications.size - 1)
    %>

    <div class="p-3 d-flex justify-content-between align-items-center">
      <small class="text-muted">
        全<%= @total_count %>件中 <%= range_start %>–<%= range_end %>件を表示
      </small>

      <nav aria-label="通知ページ">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item <%= 'disabled' unless prev_page %>">
            <% if prev_page %>
              <%= link_to '«', modal_page_notifications_path(page: prev_page),
                    data: { turbo_frame: "notifications-modal-frame" },
                    class: "page-link" %>
            <% else %>
              <span class="page-link">«</span>
            <% end %>
          </li>

          <% (1..total_pages).each do |pnum| %>
            <li class="page-item <%= 'active' if pnum == current_page %>">
              <% if pnum == current_page %>
                <span class="page-link"><%= pnum %></span>
              <% else %>
                <%= link_to pnum, modal_page_notifications_path(page: pnum),
                      data: { turbo_frame: "notifications-modal-frame" },
                      class: "page-link" %>
              <% end %>
            </li>
          <% end %>

          <li class="page-item <%= 'disabled' unless next_page %>">
            <% if next_page %>
              <%= link_to '»', modal_page_notifications_path(page: next_page),
                    data: { turbo_frame: "notifications-modal-frame" },
                    class: "page-link" %>
            <% else %>
              <span class="page-link">»</span>
            <% end %>
          </li>
        </ul>
      </nav>
    </div>
  <% end %>
</div>

<script nonce="<%= content_security_policy_nonce %>">
  // このページの10件を既読にしたので、バッジ更新イベントを投げる
  window.dispatchEvent(new Event("notifications:refresh-badge"));
</script>
