<!DOCTYPE html>
<html lang="ja">
<head>
  <title><%= content_for(:title) || "EMOTION MUSIC BOX" %></title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <meta name="description" content="感情と音楽をシェアする新感覚アプリ EMOTION MUSIC BOX。今の気持ちを音楽に変えて最高な体験を。">
  <%= favicon_link_tag 'favicon.ico' %>
  <% og_image = image_url('ogp.png') %>
  <meta property="og:title" content="Emotion Music Box (EMOMU)">
  <meta property="og:description" content="感情と音楽をシェアする新感覚アプリ">
  <meta property="og:image" content="<%= og_image %>">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://moriappli-emotion.com">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Emotion Music Box (EMOMU)">
  <meta name="twitter:description" content="感情と音楽をシェアする新感覚アプリ">
  <meta name="twitter:image" content="<%= og_image %>">
  <meta name="twitter:url" content="https://moriappli-emotion.com">

  <!-- PWA 対応 -->
  <%= tag.link rel: "manifest", href: "/manifest.json" %>
  <%= tag.meta name: "theme-color", content: "#ff69b4" %>

  <!-- SoundCloudメタ -->
  <meta name="soundcloud-client-id" content="<%= ENV['SOUNDCLOUD_CLIENT_ID'] %>">
  <% if current_user&.soundcloud_token.present? %>
    <meta name="soundcloud-oauth-token" content="<%= current_user.soundcloud_token %>">
  <% end %>

  <!-- （任意）SoundCloud SDK：未使用ならコメントアウトでOK。怖ければ残しても動作は同じ -->
  <!-- <script src="https://connect.soundcloud.com/sdk/sdk-3.3.2.js"></script> -->

  <!-- SoundCloud Player API の最適化 -->
  <link rel="dns-prefetch" href="https://w.soundcloud.com">
  <link rel="dns-prefetch" href="https://api.soundcloud.com">
  <link rel="preconnect" href="https://w.soundcloud.com" crossorigin>
  <link rel="preconnect" href="https://api.soundcloud.com" crossorigin>
  <!-- ✅ preload は crossorigin なし（CORS回避） -->
  <link rel="preload" as="script" href="https://w.soundcloud.com/player/api.js">


  <% if Rails.env.production? %>
    <script nonce="<%= content_security_policy_nonce %>">
      (function(c){
        if (!c) return;
        var noop = function(){};
        c.log   = noop;
        c.info  = noop;
        c.debug = noop;
        // 必要なら warn も無効化
        // c.warn  = noop;
        // error は残す（障害時の一次情報）ここは本番でコンソールを出さないようにする
      })(window.console = window.console || {});
    </script>
  <% end %>

  <!-- ✅ player API を defer で非ブロッキング化（機能は変わりません） -->
  <script defer src="https://w.soundcloud.com/player/api.js"></script>

  <!-- Railsのapplication.js（defer必須！） -->
  <%= javascript_include_tag "application", "data-turbo-track": "reload", type: "module", defer: true %>

  <!-- Bootswatch Cyborg (CDN) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/cyborg/bootstrap.min.css">


  <%= stylesheet_link_tag "application", "data-turbo-track": "reload", media: "all" %>

  <!-- Font Awesome（CSP対応）-->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <!-- Google Fonts 最適化 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap">
  <!-- CDN 最適化 -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>

  <!-- Bootstrap Icons（CSP対応）-->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- GSAP, SweetAlert2, Axios（deferで安全） -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.8/axios.min.js"></script>

  <!-- ✅ グローバル変数 -->
  <script nonce="<%= content_security_policy_nonce %>">
    window.SOUNDCLOUD_CLIENT_ID = "<%= ENV['SOUNDCLOUD_CLIENT_ID'] %>";
    window.soundcloudToken      = "<%= ENV['SOUNDCLOUD_OAUTH_TOKEN'] %>";
    window.CLOUDINARY_CLOUD_NAME = "<%= ENV['CLOUDINARY_CLOUD_NAME'] %>";
    window.CLOUDINARY_UPLOAD_PRESET = "<%= ENV['CLOUDINARY_UPLOAD_PRESET'] %>";
    window.VAPID_PUBLIC_KEY = "<%= ENV['VAPID_PUBLIC_KEY'] %>";
    window.isLoggedIn = <%= current_user.present? ? 'true' : 'false' %>;
  </script>

  <%= yield :head %>
  <%= Sentry.get_trace_propagation_meta.html_safe %>
  </head>
<body class="<%= content_for?(:body_class) ? yield(:body_class) : '' %>"
      data-controller="view-switcher global-player"
      data-flash-notice="<%= j flash[:notice] %>"
      data-flash-alert="<%= j flash[:alert] %>">

  <!-- ここから下は元の内容を**絶対に壊さずそのまま**にしてください -->
  <div id="screen-cover-loading" aria-hidden="true" aria-live="polite" aria-label="ローディング画面">
    <div class="pacman-wrapper" aria-hidden="true">
      <div class="circle-packman-1"></div>
      <div class="loading-text">Now Loading...</div>
    </div>
  </div>

  <turbo-frame id="playlist-modal-container"></turbo-frame>

  <div id="comment-container"></div>
  <div id="flash" class="position-fixed top-0 start-50 translate-middle-x mt-4 zindex-tooltip"></div>
  <%= flash[:notice] %>
  <%= render "shared/flash_container" %>

  <!-- ──────────── ヘッダー & コンテンツ ──────────── -->
  <%= yield %>

  <!-- ✅ 保存完了トースト(簡易型ポップアップ) -->
  <div aria-live="polite" aria-atomic="true"
     class="z-1080 position-fixed top-0 end-0 p-3">
    <div id="save-toast"
        class="toast align-items-center text-white bg-success border-0"
        role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">emomu を保存しました！</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                data-bs-dismiss="toast" aria-label="閉じる"></button>
      </div>
    </div>
  </div>

  <%= render 'shared/footer' %>

  <!-- ──────────── 下部カスタムプレーヤー & 隠し iframe ──────────── -->

  <!-- 1) SoundCloud の iframe（display: none で隠す） -->
 <iframe id="hidden-sc-player" class="hidden-frame" src="" allow="autoplay; encrypted-media" frameborder="no" scrolling="no" width="100%" height="166" aria-hidden="true" tabindex="-1"></iframe>


  <!-- ===== 下部カスタムプレーヤー ===== -->
  <div id="bottom-player" class="bottom-player d-none" role="region" aria-label="再生コントロール">
    <!-- 上段 -->
    <div class="bottom-player-top-row">
      <canvas id="waveform-anime" width="450" height="44" class="waveform-canvas" aria-hidden="true"></canvas>

      <span id="track-title-top" class="track-title-top-inline d-md-none" aria-live="polite"></span>
      <small id="track-artist-mobile" class="track-artist d-md-none" aria-live="polite"></small>

      <div class="player-center-btns">
        <button id="prev-track-button"
          class="btn btn-link text-white bottom-player-button"
          data-action="click->global-player#prevTrack"
          type="button"
          aria-label="前の曲へ">
          <i class="fa fa-step-backward" aria-hidden="true"></i>
        </button>
        <button id="next-track-button"
          class="btn btn-link text-white next-track-btn"
          data-action="click->global-player#nextTrack"
          type="button"
          aria-label="次の曲へ">
          <i class="fa fa-step-forward" aria-hidden="true"></i>
        </button>
      </div>

      <div class="bottom-player-flex-gap"></div>
    </div>

    <!-- 下段 -->
    <div class="bottom-player-controls">
      <button id="play-pause-button"
              class="btn btn-link text-white me-3 play-pause-btn"
              data-action="click->global-player#togglePlayPause"
              type="button"
              aria-label="再生">
        <i id="play-pause-icon" class="fa fa-play" aria-hidden="true"></i>
        <span id="play-btn-spinner" class="play-btn-spinner" aria-hidden="true">
          <span class="loading-spinner-inline"></span>
        </span>
      </button>

      <div id="track-info" class="track-info-box" aria-live="polite">
        <span class="loading-spinner-inline" id="loading-spinner" aria-hidden="true"></span>
        <span id="track-title" class="track-title">
          <span class="neon-wave" aria-hidden="true">
            <span>N</span><span>O</span><span>W</span>
            <span>&nbsp;</span>
            <span>L</span><span>O</span><span>A</span><span>D</span><span>I</span><span>N</span><span>G</span>
            <span>.</span><span>.</span><span>.</span>
          </span>
        </span>
        <span class="neon-character-spinbox" aria-hidden="true">
          <span class="neon-body">
            <span class="neon-eye neon-eye-left"></span>
            <span class="neon-eye neon-eye-right"></span>
            <span class="neon-arm neon-arm-left"></span>
            <span class="neon-arm neon-arm-right"></span>
            <span class="neon-leg neon-leg-left"></span>
            <span class="neon-leg neon-leg-right"></span>
          </span>
        </span>
        <small id="track-artist" class="track-artist"></small>
      </div>

      <div class="bottom-player-seekbar">
        <span id="current-time" class="current-time" aria-live="off">0:00</span>

        <label for="seek-bar" class="visually-hidden">再生位置（シーク）</label>
        <input id="seek-bar"
          type="range"
          min="0" max="100" value="0"
          class="seek-bar"
          data-action="input->global-player#seek"
          aria-label="再生位置（シーク）"
          aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-valuetext="0:00">

        <span id="duration" class="duration" aria-live="off">0:00</span>
      </div>

      <div class="bottom-player-extra-controls">
        <button id="shuffle-button" class="btn btn-link toggle-btn me-1 bottom-player-toggle-btn"
          data-action="click->global-player#toggleShuffle" type="button"
          aria-pressed="false" aria-label="シャッフルの切り替え">
          <i class="fa fa-random" aria-hidden="true"></i>
        </button>
        <button id="repeat-button" class="btn btn-link toggle-btn me-2 repeat-btn"
          data-action="click->global-player#toggleRepeat" type="button"
          aria-pressed="false" aria-label="リピートの切り替え">
          <i class="fa fa-repeat" aria-hidden="true"></i>
        </button>
        <i class="fa fa-volume-up volume-icon" aria-hidden="true"></i>

        <label for="volume-bar" class="visually-hidden">音量</label>
        <input id="volume-bar"
          type="range"
          min="0" max="100" value="100"
          class="volume-bar"
          data-action="input->global-player#changeVolume"
          aria-label="音量" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100" aria-valuetext="100%">
      </div>
    </div>
  </div>

  <div id="modal-container"></div>
  <div id="playlist-modal-root" data-turbo-permanent>
    <%= render "emotion_logs/playlist_modal", playlist: Playlist.new, modal_id: "playlist-modal" %>
  </div>
  <div id="mobile-super-search-root" data-turbo-permanent>
    <%= render "emotion_logs/mobile_super_search" %>
  </div>

</body>
</html>
